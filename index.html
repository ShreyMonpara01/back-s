<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Amazon QR Code Scanner + Barcode System</title>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
<script type="module">
  import { BrowserMultiFormatReader, NotFoundException } from "https://unpkg.com/@zxing/browser@0.0.10/esm/index.js";
  window.BarcodeScanner = BrowserMultiFormatReader;
  window.NotFoundException = NotFoundException;
</script>

<style>
body { font-family: Arial, sans-serif; background:#f8f9fa; margin:20px; }
.container { max-width:1000px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
h2 { text-align:center; margin-bottom:20px; }
form { display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; margin-bottom:15px; }
input, button { padding:8px; border-radius:6px; border:1px solid #ccc; }
button { background:#007bff; color:white; cursor:pointer; border:none; }
button:hover { background:#0056b3; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th,td { border-bottom:1px solid #ddd; padding:8px; text-align:left; }
th { background:#007bff; color:white; }
.actions button { margin-right:5px; background:#28a745; }
.actions button.delete { background:#dc3545; }
.preview { text-align:center; margin-top:15px; }
svg, canvas { display:block; margin:auto; }

.scanner-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
}
.scanner-card {
  background:white; padding:20px; border-radius:10px;
  width:min(600px,90%); text-align:center;
}
video { width:100%; border-radius:10px; background:black; }
</style>
</head>

<body>
<div class="container">
  <h2>Amazon QR Code Scanner + Barcode System</h2>

  <form id="productForm">
    <input type="text" id="productName" placeholder="Product Name" required>
    <input type="text" id="productURL" placeholder="Amazon URL or ASIN" required>
    <button type="submit">Add</button>
    <button type="button" id="scanBtn">ðŸ“· Scan QR</button>
  </form>

  <div class="preview" id="preview"></div>

  <table id="productTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Platform</th>
        <th>Name</th>
        <th>ASIN / ID</th>
        <th>Barcode</th>
        <th>QR</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- SCANNER MODAL -->
<div id="scannerOverlay" class="scanner-overlay" style="display:none;">
  <div class="scanner-card">
    <h3>Scan Amazon QR Code</h3>
    <video id="video" autoplay muted playsinline></video>
    <p id="scanStatus">Align QR within the frame...</p>
    <button id="closeScanner">Close</button>
  </div>
</div>

<script>
const form = document.getElementById("productForm");
const tableBody = document.querySelector("#productTable tbody");
const preview = document.getElementById("preview");
const scanBtn = document.getElementById("scanBtn");
const overlay = document.getElementById("scannerOverlay");
const video = document.getElementById("video");
const scanStatus = document.getElementById("scanStatus");
const closeScanner = document.getElementById("closeScanner");

let products = JSON.parse(localStorage.getItem("products") || "[]");
let scanner, stream;

// ---------- FUNCTIONS ----------
function saveProducts() {
  localStorage.setItem("products", JSON.stringify(products));
}
function parseASIN(url) {
  const match = url.match(/\/dp\/([A-Z0-9]{10})/i);
  return match ? match[1].toUpperCase() : (url.match(/([A-Z0-9]{10})/i)?.[1]?.toUpperCase() || url);
}
function generateCodes(product) {
  const barcode = document.createElement("svg");
  JsBarcode(barcode, product.asin, { format: "CODE128", width:2, height:40 });
  const qrDiv = document.createElement("div");
  new QRCode(qrDiv, { text: product.url, width:70, height:70 });
  return { barcode, qrDiv };
}
function renderTable() {
  tableBody.innerHTML = "";
  products.forEach((p, i) => {
    const tr = document.createElement("tr");
    const { barcode, qrDiv } = generateCodes(p);
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.platform}</td>
      <td>${p.name}</td>
      <td>${p.asin}</td>
      <td></td><td></td>
      <td class="actions">
        <button class="delete">Delete</button>
      </td>`;
    tr.children[4].appendChild(barcode);
    tr.children[5].appendChild(qrDiv);
    tr.querySelector(".delete").onclick = () => {
      products.splice(i,1); saveProducts(); renderTable();
    };
    tableBody.appendChild(tr);
  });
}

// ---------- FORM SUBMIT ----------
form.addEventListener("submit", e => {
  e.preventDefault();
  const name = document.getElementById("productName").value.trim();
  const url = document.getElementById("productURL").value.trim();
  const asin = parseASIN(url);
  const product = { name, url, asin, platform:"Amazon" };
  products.push(product);
  saveProducts();
  renderTable();
  preview.innerHTML = "<h3>Preview</h3>";
  const { barcode, qrDiv } = generateCodes(product);
  preview.append(barcode, qrDiv);
  form.reset();
});

// ---------- SCANNER ----------
scanBtn.onclick = async () => {
  overlay.style.display = "flex";
  scanStatus.textContent = "Initializing camera...";
  scanner = new window.BarcodeScanner();
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    video.srcObject = stream;
    await video.play();
    scanStatus.textContent = "Scanning...";
    startDecode();
  } catch(err) {
    scanStatus.textContent = "Camera not accessible: " + err.message;
  }
};

async function startDecode() {
  try {
    const result = await scanner.decodeOnceFromVideoElement(video);
    if(result && result.text) handleScanResult(result.text);
  } catch(err) {
    if(err instanceof window.NotFoundException) {
      if(overlay.style.display!=="none") setTimeout(startDecode,100);
    } else scanStatus.textContent = "Error: " + err.message;
  }
}

function handleScanResult(text) {
  scanStatus.textContent = "Scanned: " + text;
  stopScanner();
  const asin = parseASIN(text);
  const product = { 
    name: "Amazon Product " + asin, 
    url: text, 
    asin, 
    platform:"Amazon"
  };
  products.push(product);
  saveProducts();
  renderTable();
}

function stopScanner() {
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  overlay.style.display = "none";
  video.srcObject = null;
}

closeScanner.onclick = stopScanner;
renderTable();
</script>
</body>
</html>
