<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single AWB Label Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div class="max-w-3xl mx-auto py-8 px-4">
    <h1 class="text-2xl font-bold text-center mb-6">📦 Single Scan AWB Label</h1>

    <!-- Scanner -->
    <div id="reader" class="rounded-lg overflow-hidden border-4 border-red-500 shadow-md"></div>

    <!-- Controls -->
    <div class="controls bg-white p-4 rounded-lg shadow mt-4 flex flex-wrap items-center justify-center gap-3">
      <label class="font-semibold">Platform:</label>
      <select id="platform" class="border rounded p-2">
        <option value="Amazon">Amazon</option>
        <option value="Flipkart">Flipkart</option>
        <option value="Meesho">Meesho</option>
      </select>

      <label class="font-semibold">Date:</label>
      <input type="date" id="dateFilter" class="border rounded p-2" />

      <button onclick="filterByDate()" class="bg-blue-500 text-white px-4 py-2 rounded">Filter</button>
      <button onclick="clearData()" class="bg-red-500 text-white px-4 py-2 rounded">Delete All</button>
      <button onclick="downloadCSV()" class="bg-green-600 text-white px-4 py-2 rounded">Download CSV</button>
    </div>

    <!-- Orders -->
    <div class="orders bg-white p-4 rounded-lg shadow mt-6">
      <h3 class="text-lg font-semibold mb-3">Scanned Orders (<span id="totalOrders">0</span>)</h3>
      <div id="orderList" class="divide-y divide-gray-200"></div>
    </div>
  </div>

<script>
  const orderList = document.getElementById("orderList");
  const totalOrders = document.getElementById("totalOrders");
  let orders = JSON.parse(localStorage.getItem("orders")) || [];
  let html5QrCode;

  //  Beep Sounds
  function beepSuccess() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [600, 900, 1200].forEach((f, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine"; osc.frequency.value = f;
      gain.gain.value = 0.2; osc.connect(gain); gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i*0.15); osc.stop(ctx.currentTime + i*0.15 + 0.15);
    });
  }
  function beepError() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator(); const gain = ctx.createGain();
    osc.type = "sawtooth"; osc.frequency.value = 400;
    gain.gain.value = 0.3; osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 0.5);
  }

  //  Detect Platform
  function detectPlatform(code) {
    if (code.startsWith("FMPC") || code.startsWith("FMP")) return "Flipkart";
    if (code.startsWith("TBA")) return "Amazon";
    if (code.startsWith("M")) return "Meesho";
    return document.getElementById("platform").value;
  }

  //  Save Order
  function addOrder(code) {
    const platform = detectPlatform(code);
    let date = document.getElementById("dateFilter").value || new Date().toISOString().split("T")[0];

    if (orders.some(o => o.code === code && o.platform === platform && o.date === date)) {
      beepError();
      alert("⚠️ Already scanned for this date!");
      return;
    }

    const order = { code, platform, date };
    orders.push(order);
    localStorage.setItem("orders", JSON.stringify(orders));
    displayOrders(orders);
    beepSuccess();

    // Green border
    const reader = document.getElementById("reader");
    reader.classList.replace("border-red-500", "border-green-500");

    // Stop scanner (only one scan)
    stopScanner();
  }

  //  Display Orders
  function displayOrders(list) {
    orderList.innerHTML = "";
    list.forEach((o, idx) => {
      const div = document.createElement("div");
      div.className = "order-item flex justify-between items-center py-2";
      div.innerHTML = `<span>📦 <b>${o.code}</b> | 🏬 ${o.platform} | 📅 ${o.date}</span>
        <button onclick="deleteOrder(${idx})" class="text-red-500 hover:text-red-700">❌</button>`;
      orderList.appendChild(div);
    });
    totalOrders.textContent = list.length;
  }
  //  Delete
  function deleteOrder(index) {
    if (confirm("Delete this order?")) {
      orders.splice(index, 1);
      localStorage.setItem("orders", JSON.stringify(orders));
      displayOrders(orders);
    }
  }
  //  Filter
  function filterByDate() {
    const selectedDate = document.getElementById("dateFilter").value;
    displayOrders(selectedDate ? orders.filter(o => o.date === selectedDate) : orders);
  }
  //  Clear All
  function clearData() {
    if (confirm("Delete all saved orders?")) {
      orders = [];
      localStorage.removeItem("orders");
      displayOrders(orders);
    }
  }
  // CSV Download
  function downloadCSV() {
    let csv = "AWB No.,Platform,Date\n";
    orders.forEach(o => csv += `${o.code},${o.platform},${o.date}\n`);
    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "orders.csv";
    link.click();
  }
  //  Start Scanner (Single Scan)
  function startScan() {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        addOrder(decodedText);
      }
    ).catch(err => console.error("Camera start failed:", err));
  }
  //  Stop Scanner
  function stopScanner() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        console.log("Scanner stopped after one scan.");
      }).catch(err => console.error("Stop failed:", err));
    }
  }
  //  Initialize
  displayOrders(orders);
  startScan();
</script>
</body>
</html>
